// Prisma Schema for Bojang Tibetan Learning App
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// USER AND AUTHENTICATION MODELS
// =====================================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  username          String    @unique
  passwordHash      String    @map("password_hash")
  displayName       String    @map("display_name")
  profileImageUrl   String?   @map("profile_image_url")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLogin         DateTime? @map("last_login")
  isActive          Boolean   @default(true) @map("is_active")
  timezone          String    @default("UTC")
  preferredLanguage String    @default("en") @map("preferred_language")
  deviceId          String?   @map("device_id")
  lastSync          DateTime? @map("last_sync")

  // Relations
  userProgress      UserProgress?
  dailyStreaks      DailyStreak[]
  categoryProgress  CategoryProgress[]
  quizSessions      QuizSession[]
  gameScores        GameScore[]
  userAchievements  UserAchievement[]
  leaderboards      Leaderboard[]
  learningGoals     LearningGoal[]
  syncQueue         SyncQueue[]

  @@map("users")
}

model UserProgress {
  id                   String   @id @default(cuid())
  userId               String   @unique @map("user_id")
  currentLevel         Int      @default(1) @map("current_level")
  totalXp              Int      @default(0) @map("total_xp")
  currentStreak        Int      @default(0) @map("current_streak")
  longestStreak        Int      @default(0) @map("longest_streak")
  lastActivityDate     DateTime? @map("last_activity_date") @db.Date
  totalQuizzesTaken    Int      @default(0) @map("total_quizzes_taken")
  totalCorrectAnswers  Int      @default(0) @map("total_correct_answers")
  overallAccuracy      Float    @default(0.0) @map("overall_accuracy")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_progress")
}

model DailyStreak {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  activityDate     DateTime @map("activity_date") @db.Date
  quizzesCompleted Int      @default(0) @map("quizzes_completed")
  xpEarned         Int      @default(0) @map("xp_earned")
  streakDay        Int      @default(1) @map("streak_day")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, activityDate])
  @@map("daily_streaks")
}

// =====================================================
// CONTENT MODELS
// =====================================================

model Category {
  id          String   @id @default(cuid())
  name        String
  tibetanName String?  @map("tibetan_name")
  description String?
  iconUrl     String?  @map("icon_url")
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  levels           Level[]
  categoryProgress CategoryProgress[]

  @@map("categories")
}

model Level {
  id                String     @id @default(cuid())
  categoryId        String     @map("category_id")
  levelNumber       Int        @map("level_number")
  name              String
  description       String?
  difficulty        Difficulty @default(BEGINNER)
  unlockRequirement Int        @default(0) @map("unlock_requirement")
  isActive          Boolean    @default(true) @map("is_active")
  createdAt         DateTime   @default(now()) @map("created_at")

  // Relations
  category     Category      @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  questions    Question[]
  games        Game[]
  quizSessions QuizSession[]

  @@unique([categoryId, levelNumber])
  @@map("levels")
}

model Question {
  id                   String       @id @default(cuid())
  levelId              String       @map("level_id")
  questionType         QuestionType @map("question_type")
  questionText         String?      @map("question_text")
  questionTextTibetan  String?      @map("question_text_tibetan")
  questionAudioUrl     String?      @map("question_audio_url")
  questionImageUrl     String?      @map("question_image_url")
  correctAnswer        String       @map("correct_answer")
  explanation          String?
  explanationTibetan   String?      @map("explanation_tibetan")
  difficultyScore      Int          @default(1) @map("difficulty_score")
  isActive             Boolean      @default(true) @map("is_active")
  createdAt            DateTime     @default(now()) @map("created_at")
  updatedAt            DateTime     @updatedAt @map("updated_at")

  // Relations
  level       Level            @relation(fields: [levelId], references: [id], onDelete: Cascade)
  options     QuestionOption[]
  quizResults QuizResult[]

  @@map("questions")
}

model QuestionOption {
  id                 String  @id @default(cuid())
  questionId         String  @map("question_id")
  optionText         String? @map("option_text")
  optionTextTibetan  String? @map("option_text_tibetan")
  optionAudioUrl     String? @map("option_audio_url")
  optionImageUrl     String? @map("option_image_url")
  isCorrect          Boolean @map("is_correct")
  sortOrder          Int     @default(0) @map("sort_order")

  // Relations
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model Game {
  id                   String     @id @default(cuid())
  gameType             GameType   @map("game_type")
  levelId              String     @map("level_id")
  name                 String
  description          String?
  gameData             Json       @map("game_data")
  difficulty           GameDifficulty @default(EASY)
  estimatedTimeMinutes Int        @default(5) @map("estimated_time_minutes")
  xpReward             Int        @default(10) @map("xp_reward")
  isActive             Boolean    @default(true) @map("is_active")
  createdAt            DateTime   @default(now()) @map("created_at")
  updatedAt            DateTime   @updatedAt @map("updated_at")

  // Relations
  level      Level       @relation(fields: [levelId], references: [id], onDelete: Cascade)
  gameScores GameScore[]

  @@map("games")
}

// =====================================================
// PROGRESS AND TRACKING MODELS
// =====================================================

model CategoryProgress {
  id                String       @id @default(cuid())
  userId            String       @map("user_id")
  categoryId        String       @map("category_id")
  level             Int          @default(1)
  progressPercentage Float       @default(0.0) @map("progress_percentage")
  totalScore        Int          @default(0) @map("total_score")
  bestScore         Int          @default(0) @map("best_score")
  timesPracticed    Int          @default(0) @map("times_practiced")
  masteryLevel      MasteryLevel @default(BEGINNER) @map("mastery_level")
  lastPracticed     DateTime?    @map("last_practiced")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
  @@map("category_progress")
}

model QuizSession {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  levelId           String   @map("level_id")
  totalQuestions    Int      @map("total_questions")
  correctAnswers    Int      @default(0) @map("correct_answers")
  score             Int      @default(0)
  xpEarned          Int      @default(0) @map("xp_earned")
  timeTokenSeconds  Int?     @map("time_taken_seconds")
  accuracy          Float    @default(0.0)
  completedAt       DateTime @default(now()) @map("completed_at")
  createdAt         DateTime @default(now()) @map("created_at")
  isSynced          Boolean  @default(false) @map("is_synced")
  offlineSessionId  String?  @map("offline_session_id")
  deviceTimestamp   DateTime? @map("device_timestamp")

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  level       Level        @relation(fields: [levelId], references: [id], onDelete: Cascade)
  quizResults QuizResult[]

  @@map("quiz_sessions")
}

model QuizResult {
  id               String   @id @default(cuid())
  sessionId        String   @map("session_id")
  questionId       String   @map("question_id")
  userAnswer       String   @map("user_answer")
  correctAnswer    String   @map("correct_answer")
  isCorrect        Boolean  @map("is_correct")
  timeTokenSeconds Int?     @map("time_taken_seconds")
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  session  QuizSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("quiz_results")
}

model GameScore {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  gameId          String    @map("game_id")
  score           Int
  timeTokenSeconds Int?     @map("time_taken_seconds")
  movesCount      Int?      @map("moves_count")
  xpEarned        Int       @default(0) @map("xp_earned")
  playedAt        DateTime  @default(now()) @map("played_at")
  isSynced        Boolean   @default(false) @map("is_synced")
  offlineScoreId  String?   @map("offline_score_id")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@map("game_scores")
}

// =====================================================
// ACHIEVEMENT MODELS
// =====================================================

model Achievement {
  id               String           @id
  name             String
  description      String
  iconUrl          String?          @map("icon_url")
  category         String
  requirementValue Int?             @map("requirement_value")
  xpReward         Int              @default(0) @map("xp_reward")
  rarity           AchievementRarity @default(COMMON)
  isActive         Boolean          @default(true) @map("is_active")
  createdAt        DateTime         @default(now()) @map("created_at")

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  isSynced      Boolean  @default(false) @map("is_synced")

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// =====================================================
// LEADERBOARD AND SOCIAL MODELS
// =====================================================

model Leaderboard {
  id               String          @id @default(cuid())
  userId           String          @map("user_id")
  leaderboardType  LeaderboardType @map("leaderboard_type")
  score            Int
  rank             Int?
  periodIdentifier String?         @map("period_identifier")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("leaderboards")
}

model LearningGoal {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  goalType     GoalType @map("goal_type")
  targetValue  Int      @map("target_value")
  currentValue Int      @default(0) @map("current_value")
  isActive     Boolean  @default(true) @map("is_active")
  startDate    DateTime @map("start_date") @db.Date
  endDate      DateTime? @map("end_date") @db.Date
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("learning_goals")
}

// =====================================================
// SYNC AND VERSIONING MODELS
// =====================================================

model SyncQueue {
  id            String        @id @default(cuid())
  userId        String        @map("user_id")
  operationType OperationType @map("operation_type")
  tableName     String        @map("table_name")
  recordId      String        @map("record_id")
  operationData Json          @map("operation_data")
  createdAt     DateTime      @default(now()) @map("created_at")
  syncedAt      DateTime?     @map("synced_at")
  isSynced      Boolean       @default(false) @map("is_synced")
  retryCount    Int           @default(0) @map("retry_count")
  errorMessage  String?       @map("error_message")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sync_queue")
}

model ContentVersion {
  id          String      @id @default(cuid())
  contentType ContentType @map("content_type")
  versionNumber Int       @map("version_number")
  releaseDate DateTime    @default(now()) @map("release_date")
  description String?
  isActive    Boolean     @default(true) @map("is_active")
  downloadUrl String?     @map("download_url")

  @@map("content_versions")
}

model DeviceContent {
  id            String      @id @default(cuid())
  deviceId      String      @map("device_id")
  contentType   ContentType @map("content_type")
  versionNumber Int         @map("version_number")
  lastUpdated   DateTime    @default(now()) @map("last_updated")

  @@unique([deviceId, contentType])
  @@map("device_content")
}

// =====================================================
// ENUMS
// =====================================================

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum QuestionType {
  MULTIPLE_CHOICE
  FILL_BLANK
  PRONUNCIATION
  MATCHING
  AUDIO_TO_TEXT
  TEXT_TO_AUDIO
  IMAGE_TO_TEXT
  TEXT_TO_IMAGE
  AUDIO_MULTIPLE_CHOICE
  IMAGE_MULTIPLE_CHOICE
}

enum GameType {
  MEMORY_MATCH
  WORD_PUZZLE
  PRONUNCIATION_PRACTICE
  SENTENCE_BUILDER
}

enum GameDifficulty {
  EASY
  MEDIUM
  HARD
}

enum MasteryLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  MASTERED
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum LeaderboardType {
  WEEKLY_XP
  MONTHLY_STREAK
  ALL_TIME_SCORE
  CATEGORY_MASTERY
}

enum GoalType {
  DAILY_QUIZZES
  WEEKLY_XP
  STREAK_TARGET
  CATEGORY_COMPLETION
}

enum OperationType {
  QUIZ_SESSION
  GAME_SCORE
  ACHIEVEMENT
  PROGRESS_UPDATE
}

enum ContentType {
  QUESTIONS
  GAMES
  ACHIEVEMENTS
  CATEGORIES
}
